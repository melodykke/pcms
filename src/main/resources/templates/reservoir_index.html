<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var baseInfoId = [[${baseInfoId}]];
        /*]]>*/
    </script>

    <meta charset="utf-8">

    <link rel="shortcut icon" href="icon/new.ico" type="image/x-icon"/>
    <!-- 自定义 -->

    <link th:href="@{/css/custom/reservoir_detail.css}" rel="stylesheet">

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body class="md-skin fixed-nav no-skin-config">
<!-- <body> -->

<div class="row wrapper border-bottom white-bg page-heading" id="main-breadcrumb">
    <div class="col-sm-4">
        <h2>水库详情</h2>
        <ol class="breadcrumb">
            <li>
                <a href="all_reservoir.html">所有水库</a>
            </li>
            <li class="active">
                <strong>水库详情</strong>
            </li>
        </ol>
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row col-lg-12 col-md-12 panel-row">
        <div class="ibox reservoir-item">
            <div class="ibox-title">
                <h5>项目概况</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <div class="scroll_content">
                    <div class="reservoir-panel-row col-lg-12 col-md-12">
                        <div class="reservoir-panel col-lg-9 col-md-9">
                            <!-- 第一行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>水库名：</label>
                                    <div>
                                        <span id="plantNameInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>规模：</label>
                                    <div>
                                        <span id="scaleInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>工程等别：</label>
                                    <div>
                                        <span id="levelInfo">Ⅲ</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第七行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>坝型：</label>
                                    <div>
                                        <span id="damTypeInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>最大坝高(m)：</label>
                                    <div>
                                        <span id="maxDamHeightInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>泄洪道(m)：</label>
                                    <div>
                                        <span id="spillwayInfo">AAA</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第二行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>法人：</label>
                                    <div>
                                        <span id="legalRepresentativeNameInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>上报人：</label>
                                    <div>
                                        <span id="ownerInfo">张三</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>所在县：</label>
                                    <div>
                                        <span id="countyInfo">张三</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第三行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>位置：</label>
                                    <div>
                                        <span id="locationInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>纬度：</label>
                                    <div>
                                        <span id="latitudeInfo">Ⅲ</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>经度：</label>
                                    <div>
                                        <span id="longitudeInfo">张三</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>库容：</label>
                                    <div>
                                        <span id="storageInfo">Ⅲ</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>兴利库容：</label>
                                    <div>
                                        <span id="utilizablCapacityInfo">Ⅲ</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>装机容量(Kw)：</label>
                                    <div>
                                        <span id="installedCapacityInfo">张三</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第四行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>灌溉面积：</label>
                                    <div>
                                        <span id="irrigatedAreaInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>积水面积(km2)：</label>
                                    <div>
                                        <span id="catchmentAreaInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>大牲畜(万头)：</label>
                                    <div>
                                        <span id="livestockInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第五行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>城镇供水人口(万人)：</label>
                                    <div>
                                        <span id="waterSupplyPopulationInfo">张三</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>农村人饮(万人)：</label>
                                    <div>
                                        <span id="ruralHumanWaterInfo">Ⅲ</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>供水量：</label>
                                    <div>
                                        <span id="watersupplyInfo">中型</span>
                                    </div>
                                </div>

                            </div>
                            <!-- 第六行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>枢纽工程是否完工：</label>
                                    <div>
                                        <span id="hasProjectCompletedInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label title="是否竣工验收">是否竣工验收：</label>
                                    <div>
                                        <span id="hasAcceptCompletionInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>工期：</label>
                                    <div>
                                        <span id="timeLimitInfo">中型</span>
                                    </div>
                                </div>
                                <!-- <div class="col-lg-4 col-md-4">
                                    <label>当地累计拨付:</label>
                                    <div>
                                        <span id="localAccumulativePaymentInfo">AAA</span>
                                    </div>
                                </div> -->
                            </div>
                            <!-- 第十行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>项目来源：</label>
                                    <div>
                                        <span id="projectSourceInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>分部工程数：</label>
                                    <div>
                                        <span id="branchProjectAmountInfo">中型</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>单元工程数：</label>
                                    <div>
                                        <span id="cellProjectAmountInfo">张三</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十一行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>是否签订枢纽工程施工承包合同：</label>
                                    <div>
                                        <span id="hasSignedConstructionContractInfo">张三</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>工程占地(亩)：</label>
                                    <div>
                                        <span id="areaCoverageInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>度汛高程：</label>
                                    <div>
                                        <span id="floodControlElevationInfo">张三</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十一行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-4 col-md-4">
                                    <label>资金来源：</label>
                                </div>
                                <div class="col-lg-4 col-md-4">

                                </div>
                                <div class="col-lg-4 col-md-4">
                                    <label>到位资金：</label>
                                </div>
                            </div>
                        </div>
                        <div class="project-charts col-lg-3 col-md-3">
                            <div id="allmap" style="width: 100%; height: 280px;"></div>
                            <div class="col-lg-12 col-md-12 detail-total-investment">
                                <label>总投资(万元)：</label>
                                <div>
                                    <span id="totalInvestmentInfo">Ⅲ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="reservoir-panel-row col-lg-12 col-md-12 chart-area">
                        <div class="col-lg-6 col-md-6">
                            <div class="col-lg-6 col-md-6">
                                <div id="touzi" style='width: 100%;height:250px;'></div>
                            </div>
                            <div class="col-lg-6 col-md-6 panel-item">
                                <div class="col-lg-12 col-md-12">
                                    <label>市县投资(万元):</label>
                                    <div>
                                        <span id="localInvestmentInfo">Ⅲ</span>
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12">
                                    <label>省级投资(万元)：</label>
                                    <div>
                                        <span id="provincialInvestmentInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12">
                                    <label>中央投资(万元)：</label>
                                    <div>
                                        <span id="centralInvestmentInfo">AAA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="col-lg-6 col-md-6">
                                <div id="payment_chart" style='width: 100%;height:250px;'></div>
                            </div>
                            <div class="col-lg-6 col-md-6 panel-item">
                                <div class="col-lg-12 col-md-12">
                                    <label>市县投资(万元):</label>
                                    <div>
                                        <span id="localAccumulativePaymentInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12">
                                    <label>省级投资(万元):</label>
                                    <div>
                                        <span id="provincialAccumulativePaymentInfo">AAA</span>
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12 ">
                                    <label>中央投资(万元)：</label>
                                    <div>
                                        <span id="centralAccumulativePaymentInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="reservoir-panel-row col-lg-12 col-md-12 panel-item-detail">
                        <div class="reservoir-panel">
                            <!-- 第七行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>概况：</label>
                                    <div>
                                        <span id="overviewInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第七行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>分部工程概况：</label>
                                    <div>
                                        <span id="branchProjectOverviewInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>单位工程概况：</label>
                                    <div>
                                        <span id="unitProjectOverviewInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>单元工程概况：</label>
                                    <div>
                                        <span id="cellProjectOverviewInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十一行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>工程任务及主要建筑物：</label>
                                    <div>
                                        <span id="projectTaskInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第八行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>建设用地：</label>
                                    <div>
                                        <span id="constructionLandInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第九行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>土地复垦方案：</label>
                                    <div>
                                        <span id="landReclamationPlanInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十二行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>监理、施工招标情况：</label>
                                    <div>
                                        <span id="supervisorBidInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 第十行 -->
                            <div class="form-row col-lg-12 col-md-12">
                                <div class="col-lg-12 col-md-12">
                                    <label>备注：</label>
                                    <div>
                                        <span id="remarkInfo">中型</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row col-lg-12 col-md-12">
        <div class="ibox reservoir-detail month-paper collapsed">
            <div class="ibox-title">
                <h5>项目月报</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <div class="scroll_content">
                    <div class="year-drop">
                        <label class="time-title">时间：</label>
                        <div class="form-group" id="year_picker">
                            <div class="input-group date">
                                            <span class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </span>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="month-btn">
                        <a class="col-lg-1 col-md-1 gray" value="1">
                            <i>1月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="2">
                            <i>2月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="3">
                            <i>3月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="4">
                            <i>4月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="5">
                            <i>5月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="6">
                            <i>6月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="7">
                            <i>7月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="8">
                            <i>8月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="9">
                            <i>9月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="10">
                            <i>10月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="11">
                            <i>11月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                        <a class="col-lg-1 col-md-1 gray" value="12">
                            <i>12月</i>
                            <div class="download-btn">
                                <i class="fa fa-file-excel-o"></i>
                                <i class="fa fa-file-pdf-o"></i>
                            </div>
                        </a>
                    </div>
                    <div class="attach-content">
                        <label>附件：</label>
                        <div class="animated fadeInRight">
                            <i class="fa fa-file-pdf-o"></i>
                        </div>
                    </div>
                    <div class="month-paper-content">
                        <table class="table table-striped table-bordered table-hover dataTables-example"
                               style="width:100%">
                            <thead>
                            <tr>
                                <th style="text-align: center;padding-top:30px">I.代 码</th>
                                <th style="text-align: center;padding-top:30px">II．指 标 名 称</th>
                                <th style="text-align: center;padding-top:30px">III．计 量 单 位</th>
                                <th style="text-align: center;padding-top:30px">IV．本 月</th>
                                <th style="text-align: center;padding-top:30px">V．本 年 累 计</th>
                                <th style="text-align: center;padding-top:30px">VI．开 工 累 计</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row reservoir-row col-lg-12 col-md-12">
        <div class="ibox reservoir-item reservoir-rain collapsed">
            <div class="ibox-title">
                <h5>当天雨情</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <div class="scroll_content">
                    <div class="col-lg-12 col-md-12 rain-detail">
                        <div class="col-lg-4 col-md-4">
                            <label>总降雨量：</label>
                            <div>
                                <span id="total_rain">50mm</span>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <label>时间：</label>
                            <div>
                                <span id="the_day">2018-08-13</span>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <label>周期：</label>
                            <div>
                                <span id="time_cycle">1天</span>
                            </div>
                        </div>
                    </div>
                    <div class="rain-situation">
                        <div id="rain_situation" style="width: 100%;height: 200px;"></div>
                    </div>
                    <div class="water-height">
                        <div id="water_height" style="width: 100%;height: 200px;"></div>
                    </div>
                    <div class="water-flow">
                        <div id="water_flow" style="width: 100%;height: 200px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 弹出层 -->
<div id="dialog" class="dialog-hide animated fadeInRight"></div>
<!-- 遮罩层 -->
<div id="mask" class="mask-position"></div>
<!-- 全屏层 -->
<div id="fullscreen_map" style="display: none;">test</div>


<!-- Date range picker -->
<script th:src="@{/js/plugins/daterangepicker/daterangepicker.js}"></script>

<script th:src="@{/js/inspinia.js}"></script>
</body>
<script>
    $('#year_picker .input-group.date').datepicker({
        startView: 2,
        minViewMode: 2,
        // todayBtn: "linked",
        keyboardNavigation: false,
        forceParse: false,
        autoclose: true,
        format: "yyyy",
        startDate: "2018",
        // language: 'zh-CN',
        defaultDate: new Date()
    }).on('changeDate', function () {
        var year = $('#year_picker .input-group.date>input').val(),
            param = {year: year, baseInfoId: baseInfoId};
        $.ajax({
            url: "monthlyreport/managergetmonthlyreports",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(param),
            dataType: 'json',
            success: function (data) {
                if (data.data && data.data.length > 0) {
                    changeMonthState(data.data);
                } else{
                    changeMonthState([]);
                }
            }
        })
    });

    function resetMonthBtn(dataList, idList) {
        $(".month-btn>a").map(function (i, dom) {
            if (dataList.indexOf($(dom).attr("value")) > -1) {
                $(dom).removeClass("gray");
                $(dom).attr("id", idList[dataList.indexOf($(dom).attr("value"))]);
            } else {
                $(dom).addClass("gray");
            }
        });
    }

    function changeMonthState(monthData) {
        var monthList = [],
            idList = [];
        $.each(monthData, function (i, n) {
            monthList.push(n.month);
            idList.push(n.projectMonthlyReportId);
        });
        // 重置a标签
        resetMonthBtn(monthList, idList);
    }

    function initReservoirPanel(data) {
        $.each(data, function (i, n) {
            var dom = $('[id="' + i + 'Info"]');
            if (dom && dom.length > 0) {
                $(dom).text(n);
                $(dom).attr("title", n);
            }
        });
    }

    function getUrlParam() {
        var paramStr = location.search.substr(1);
        var param = "";
        if (paramStr) {
            param = {};
            param[paramStr.substr(0, paramStr.indexOf("="))] = paramStr.substr(paramStr.indexOf("=") + 1);
        }
        return param;
    }

    function getAllReservoirData() {
        var def = $.Deferred();
        var keyJson = ['baseInfoId', 'areaCoverage', 'branchProjectAmount', 'branchProjectOverview', 'catchmentArea', 'cellProjectAmount', 'cellProjectOverview', 'centralAccumulativePayment', 'centralInvestment', 'constructionLand',
            'county', 'createTime', 'damType', 'floodControlElevation', 'hasAcceptCompletion', 'hasProjectCompleted', 'hasSignedConstructionContract', 'installedCapacity', 'irrigatedArea', 'landReclamationPlan',
            'latitude', 'legalPersonId', 'legalPersonName', 'legalRepresentativeId', 'legalRepresentativeName', 'level', 'livestock', 'localAccumulativePayment', 'localInvestment', 'location',
            'longitude', 'maxDamHeight', 'overview', 'owner', 'parentId', 'plantName', 'projectSource', 'projectTask', 'projectType', 'provincialAccumulativePayment',
            'provincialInvestment', 'provincialLoan', 'remark', 'ruralHumanWater', 'scale', 'spillway', 'storage', 'supervisorBid', 'timeLimit', 'totalInvestment',
            'unitProjectAmount', 'unitProjectOverview', 'updateTime', 'utilizablCapacity', 'waterSupplyPopulation', 'watersupply', 'state', 'repeatTimes'];
        $.ajax({
            url: 'baseinfo/getbaseinfobyid?baseInfoId=' + baseInfoId,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                def.resolve(data);
            },
            error: function (err) {
                // 处理本地数据字段
                var dataJson = err.responseText;
                var dataList = dataJson.split('),'),
                    itemList = [];
                dataList.map(function (item) {
                    var itemJson;
                    if (item.trim().indexOf("(") === 0) {
                        itemJson = item.trim().substr(1);
                    } else {
                        itemJson = item.trim();
                    }
                    if (itemJson.trim().lastIndexOf(")") === itemJson.trim().length - 1) {
                        itemJson = itemJson.trim().substr(item.trim().length - 1);
                    }
                    item = itemJson.split(",");
                    var itemMap = {};
                    $.each(item, function (i, n) {
                        itemMap[keyJson[i]] = n.replace(/'/g, "");
                    });
                    itemList.push(itemMap);
                });
                def.resolve(itemList);
            }
        });
        return def.promise();
    }
    function initRainSituation(plantName) {
        $("#rain_situation").remove();
        $(".rain-situation").append('<div id="rain_situation" style="width: 100%;height: 300px;"></div>');
        $("#water_height").remove();
        $(".water-height").append('<div id="water_height" style="width: 100%;height: 300px;"></div>');
        $("#water_flow").remove();
        $(".water-flow").append('<div id="water_flow" style="width: 100%;height: 300px;"></div>');
        var initEchart = function (data, id, chartName, yName) {
            var rainEchart = echarts.init(document.getElementById(id));
            var option = {
                title: {
                    text: chartName
                },
                legend: {
                    data: data.legendData
                },
                tooltip: {
                    trigger: 'axis'
                },
                grid: {
                    left: '4%',
                    right: '5%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    name: "时段",
                    type: 'category',
                    boundaryGap: false,
                    data: data.xAxisData
                },
                yAxis: {
                    type: 'value',
                    name: yName,
                    min: function (value) {
                        return (value.min - 10 > 0) ? value.min - 10 : 0;
                    }
                },
                series: data.seriesData
            };
            rainEchart.setOption(option);
        }
        // 处理雨情数据
        var rainSituationDataFun = function (data, xAxisKey, seriesKey) {
            var xAxisData = [],
                seriesData = [],
                legendData = [];
            $.each(data, function (i, n) {
                if (n.data && n.data.length > 0) {
                    legendData.push(n.name);
                    var seriesItem = [],
                        xAxisItem = [];
                    $.each(n.data, function (index, itemData) {
                        seriesItem.push(itemData.drp);
                        xAxisItem.push(itemData.tm);
                    });
                    seriesData.push({
                        name: n.name,
                        type: 'line',
                        smooth: true,
                        showSymbol: false,
                        data: seriesItem
                    });
                    if (xAxisData.length === 0) {
                        xAxisData = xAxisItem
                    }
                }
            });
            return { legendData: legendData, xAxisData: xAxisData, seriesData: seriesData }
        };
        var otherDataFun = function (data) {
            var xAxisData = [],
                seriesHeightData = [],
                serierFlowData = [],
                legendData = [];
            $.each(data, function (i, n) {
                if (n.data && n.data.length > 0) {
                    legendData.push(n.name);
                    var seriesHeightItem = [],
                        serierFlowItem = [],
                        xAxisItem = [];
                    $.each(n.data, function (index, itemData) {
                        seriesHeightItem.push(itemData.z);
                        serierFlowItem.push(itemData.q);
                        var thisDate = new Date(parseInt(itemData.tm)),
                            thisDataStr = thisDate.toISOString().substr(0, 10) + " " + thisDate.toLocaleTimeString().substr(0, 8);
                        xAxisItem.push(thisDataStr);
                    });
                    seriesHeightData.push({
                        name: n.name,
                        type: 'line',
                        smooth: true,
                        showSymbol: false,
                        data: seriesHeightItem
                    });
                    serierFlowData.push({
                        name: n.name,
                        type: 'line',
                        smooth: true,
                        showSymbol: false,
                        data: serierFlowItem
                    });
                    if (xAxisData.length === 0) {
                        xAxisData = xAxisItem;
                    }
                }
            });
            var waterHeightData = { legendData: legendData, xAxisData: xAxisData, seriesData: seriesHeightData },
                waterFlowData = { legendData: legendData, xAxisData: xAxisData, seriesData: serierFlowData };
            return { waterHeightData: waterHeightData, waterFlowData: waterFlowData }
        }
        // 参数
        var nowDate = new Date(),
            nowDateStr = nowDate.toISOString().substr(0, 10) + " " + nowDate.toTimeString().substr(0, 8),
            lastDate = nowDate.getFullYear() + "-" + (nowDate.getMonth()+1) + "-" + (nowDate.getDate()-1) + " " + nowDate.toTimeString().substr(0, 8);
        var param = {
            plantName: plantName,
            startTime: lastDate,
            endTime : nowDateStr
        }
        // 降雨量
        $.ajax({
             url: 'communication/getallrainfalldata',
//            url: 'json/rain_situation.json',
            type: 'GET',
            data: param,
            dataType: 'json',
            success: function (data) {
                var rainData = data.data;
                var thisRainData = rainSituationDataFun(rainData, 'tm', 'drp');
                initEchart(thisRainData, "rain_situation", "降雨量", "雨量值(mm)");
            }
        });
        // 流量及水位
        $.ajax({
             url: 'communication/getallwaterleveldata',
//            url: 'json/rain.json',
            type: 'GET',
            data: param,
            dataType: 'json',
            success: function (data) {
                var waterData = data.data;
                var thisWaterData = otherDataFun(waterData);
                initEchart(thisWaterData.waterHeightData, "water_height", "水位", "水位(m)");
                initEchart(thisWaterData.waterFlowData, "water_flow", "流量", "流量(m3/s)");
            }
        });
    }
    // 定义两个定时器
    var monthCircle = {
        fadeOutIndex: 0,
        fadeInIndex: 0
    };
    var attachCircle = {
        fadeOutIndex: 0,
        fadeInIndex: 0
    };

    // 动画效果
    function itemFade(parentDom, itemList, circle) {
        // 清除上一次的定时器
        $.each(circle, function (i, n) {
            clearInterval(n);
        });
        var timer = 0;
        // 淡出
        var iList = $(parentDom).find("i"),
            index = 0;
        var fadeOutIndex = setInterval(function () {
            $(iList[index]).removeClass("fadeInRight").addClass("fadeOutRight");
            // 停止计时器
            if (!iList[index + 1]) {
                $(parentDom).html("");
                clearInterval(fadeOutIndex);
                fadeOut();
            }
            index++;
        }, 100);
        circle.fadeOutIndex = fadeOutIndex;
        // 定时器，开始append
        var fadeOut = function () {
            var outIndex = 0;
            var fadeInIndex = setInterval(function () {
                $(parentDom).append(itemList[outIndex]);
                if (!itemList[outIndex + 1]) {
                    clearInterval(fadeInIndex);
                }
                outIndex++;
            }, 100);
            circle.fadeInIndex = fadeInIndex;
        }
    }

    function changeFile(attachmentData) {
        if (attachmentData.length === 0) {
            return false;
        }
        var timer = 0;
        var file = [];
        $.each(attachmentData, function (i, attachmentItem) {
            var type = attachmentItem.thumbnailAddr.substr(attachmentItem.thumbnailAddr.lastIndexOf(".") + 1),
                name = attachmentItem.thumbnailAddr.substring(attachmentItem.thumbnailAddr.lastIndexOf("/") + 1);
            switch (type.toLowerCase()) {
                case "jpg":
                    file.push('<i class="fa fa-file-image-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "png":
                    file.push('<i class="fa fa-file-image-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "jpeg":
                    file.push('<i class="fa fa-file-image-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "gif":
                    file.push('<i class="fa fa-file-image-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "bmp":
                    file.push('<i class="fa fa-file-image-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "pdf":
                    file.push('<i class="fa fa-file-pdf-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "xls":
                    file.push('<i class="fa fa-file-excel-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                case "xlsx":
                    file.push('<i class="fa fa-file-excel-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
                default:
                    file.push('<i class="fa fa-file-archive-o animated fadeInRight" title="' + name + '" url="' + attachmentItem.imgAddr + '"></i>');
                    break;
            }
        });
        // itemFade($(".file-content>div"), file, monthCircle);
        itemFade($(".attach-content>div"), file, attachCircle);
    }

    function initPieChart(id, chartData) {
        var myChart = echarts.init(document.getElementById(id));
        // 图例数据
        var legendData = [];
        $.each(chartData, function (i, n) {
            legendData.push(n.name);
        });
        // echart配置项
        var option = {
            tooltip: {
                trigger: 'item',
                formatter: "<div style='text-align:left'>{b} <br/>￥{c}({d}%)</div>"
            },
            legend: {
                orient: 'vertical',
                x: 'left',
                data: legendData,
                show: false
            },
            series: [
                {
                    name: '资金',
                    type: 'pie',
                    radius: ['50%', '70%'],
                    avoidLabelOverlap: false,
                    label: {
                        normal: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            show: true,
                            textStyle: {
                                fontSize: '14',
                                fontWeight: 'bold'
                            }
                        }
                    },
                    labelLine: {
                        normal: {
                            show: false
                        }
                    },
                    data: chartData
                }
            ]
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
        console.log('success, done');
    }

    function initLocationMap(longitude, latitude) {
        // 百度地图API功能
        var map = new BMap.Map("allmap", {mapType: BMAP_HYBRID_MAP});
        var point = new BMap.Point(longitude, latitude);  // (经度， 纬度))
        map.centerAndZoom(point, 9); // 初始化地图，设置中心店坐标和地图级别
        map.setCurrentCity("贵阳");
        map.enableScrollWheelZoom(true);

        //控制地图的最大和最小缩放级别
        map.setMinZoom(8);

        // 地图打点
        createMarker(map, longitude, latitude);
    }

    // 地图打点
    function createMarker(map, longitude, latitude) {
        var myIcon = new BMap.Icon("icon/水库点.png", new BMap.Size(25, 25), {
            imageSize: new BMap.Size(25, 25)
        });
        // 创建标注对象并添加到地图   
        var point_item = new BMap.Point(longitude, latitude);
        var marker = new BMap.Marker(point_item, {icon: myIcon});
        // var marker = new BMap.Marker(point_item);
        map.addOverlay(marker);
    }

    function initDataTable(data, formTips) {
        $(".month-paper-content").html('<table class="table table-striped table-bordered table-hover dataTables-example" style="width:100%"><thead><tr><th style="text-align: center;padding-top:30px">I.代 码</th><th style="text-align: center;padding-top:30px">II．指 标 名 称</th><th style="text-align: center;padding-top:30px">III．计 量 单 位</th><th style="text-align: center;padding-top:30px">IV．本 月</th><th style="text-align: center;padding-top:30px">V．本 年 累 计</th><th style="text-align: center;padding-top:30px">VI．开 工 累 计</th></tr></thead><tbody></tbody></table>');
        $('.month-paper-content>.dataTables-example').DataTable({
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            bFilter: false,    //去掉搜索框
            retrieve: true,
            destroy: true,
            bInfo: false,       //去掉显示信息
            data: data,
            paging: false,
            ordering: false,
            bAutoWidth: true,
            lengthChange: false,
            responsive: true,
            dom: '<"html5buttons"B>lTfgitp',
            buttons: [
                {extend: 'copy'},
                {extend: 'csv'},
                {extend: 'excel', title: '水库项目基本信息'},
                {
                    "extend": 'pdf',
                    'title': formTips.projectName + '月报(' + formTips.year + '-' + formTips.month + ')', //导出文件名字
                    "filename": "*",
                    'text': 'PDF预览', //定义导出excel按钮的文字
                    "aButtons": "true",
                    "sCharSet": "utf8",
                    "download": "open",
                    'header': true,
                },
                {
                    "extend": 'pdf',
                    'title': formTips.projectName + '月报(' + formTips.year + '-' + formTips.month + ')', //导出文件名字
                    "filename": "*",
                    'text': 'PDF导出', //定义导出excel按钮的文字
                    "aButtons": "true",
                    "sCharSet": "utf8",
                    'header': true,
                },
                {
                    extend: 'print',
                    "title": formTips.projectName + '月报(' + formTips.year + '-' + formTips.month + ')',
                    customize: function (win) {
                        $(win.document.body).addClass('white-bg');
                        $(win.document.body).css('font-size', '10px');

                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css('font-size', 'inherit');
                    }
                }
            ]
        });
    }

    $(function () {
        var param = getUrlParam(),
            reservoirData = {};
        if (baseInfoId) {
            $.when(getAllReservoirData()).done(function (data) {
                initReservoirPanel(data.data);      // 页面赋值
                initLocationMap(data.data.longitude, data.data.latitude);      // 地图数据
                reservoirData = data.data;
            });
        }
        // 生成饼图
        var paymentData = [{value: 1500000, name: '中央累计拨付'}, {value: 2100000, name: '市县累计拨付'}, {
            value: 2100000,
            name: '省级累计拨付'
        }];
        var investmentData = [{value: 1500000, name: '中央投资'}, {value: 2100000, name: '市县投资'}, {
            value: 2100000,
            name: '省级投资'
        }]
        initPieChart("payment_chart", paymentData);
        initPieChart("touzi", investmentData);
        // 月报及附件下载切换
        $(".month-btn").on("click", "a", function () {
            $(this).addClass("active").siblings().removeClass("active");
            // 参数获取
            var month = $(this).attr("value"),
                year = $('#year_picker .input-group.date>input').val(),
                projectMonthlyReportId = $(this).attr("id");
            var param = {
                projectMonthlyReportId: projectMonthlyReportId,
                currentDate: (year + "-" + (parseInt(month) < 10 ? (0 + month) : month)),
                baseInfoId: baseInfoId
            }
            var formTips = {
                projectName: reservoirData.plantName || "testName",
                year: year,
                month: month
            }
            // 请求服务
            $.ajax({
                url: 'monthlyreport/managergetmonthlyreportexcelbyprojectid',
                type: 'GET',
                data: param,
                dataType: 'json',
                beforeSend: function () {
                    $(".month-paper-content").show();
                    $(".attach-content").show();
                },
                success: function (data) {
                    if (data.code === 1002) {
                        initDataTable(data.data, formTips);
                    }
                },
                error: function (err) {
                    // 附件展现
                    var attachData = [{type: "img", name: "水库图片", url: "xxx1"}, {
                        type: "excel",
                        name: "水库EXCEL",
                        url: "xxx2"
                    }, {type: "PDF", name: "水库PDF", url: "xxx3"}];
                    changeFile(attachData);
                }
            });
            // 请求服务  ----  附件下载
            $.ajax({
                url: 'monthlyreport/getprojectmonthlyreportbyprojectmonthlyreportid',
                type: 'POST',
                data: {projectMonthlyReportId: projectMonthlyReportId},
                dataType: 'json',
                success: function (data) {
                    if (data.code === 1002 && Object.keys(data).length > 0 && Object.keys(data.data).length > 0) {
                        changeFile(data.data.projectMonthlyReportImgVOList);
                    }
                }
            })
        });

        // 附件下载事件
        $(".attach-content>div").on("click", "i", function () {
            var imgAddr = $(this).attr("url");
            location.href = "/download/monthlyreportfile?fileId=" + imgAddr;
        });
        // 下拉面板点击事件
        $(".reservoir-row").on("click", ".border-bottom .ibox-tools>.collapse-link>i", function () {
            if (!$(".reservoir-rain .ibox-content").is(":hidden")) {
                initRainSituation(reservoirData.plantName);
            }
        });
    });
</script>

</html>